<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canlı Yayın Yap - Dünyanın En Acayip Sitesi</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #000000;
            color: #ff0000;
            text-align: center;
            padding: 50px;
        }
        h1 {
            font-style: italic;
        }
        .button {
            display: inline-block;
            background-color: #ff0000;
            color: #ffffff;
            padding: 15px 30px;
            margin: 10px;
            text-decoration: none;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            cursor: pointer;
        }
        .button:hover {
            background-color: #cc0000;
        }
        input, select, textarea {
            padding: 10px;
            margin: 10px;
            width: 300px;
        }
        #productList {
            display: none;
            background-color: #ffffff;
            color: #000000;
            max-height: 200px;
            overflow-y: auto;
            width: 300px;
            margin: 0 auto;
            border: 1px solid #ff0000;
            border-radius: 5px;
        }
        .productItem {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #ddd;
        }
        .productItem:hover {
            background-color: #f0f0f0;
        }
        .productItem:last-child {
            border-bottom: none;
        }
        #subtitles {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: #ffffff;
            padding: 10px;
            border-radius: 5px;
            font-size: 18px;
            display: none;
        }
    </style>
</head>
<body>
    <h1><i>Canlı Yayın Yap</i></h1>
    <p>Ürünlerinizi seçin ve sloganınızı yazın.</p>

    <!-- Ürün Seçimi -->
    <div id="productSelection" style="margin: 20px 0; padding: 20px; border: 1px solid #ff0000; border-radius: 5px; background-color: #ffffff; color: #000000;">
        <h3>Canlı Yayında Satılacak Ürünler</h3>
        <p id="noProductsMessage" style="color: #ff0000; display: none;">Hiç ürün yok, ürün ekleyin.</p>
        <div id="productCheckboxes"></div>
    </div>

    <label for="slogan">Slogan / Cümleler (Yayın altında görünecek):</label><br>
    <textarea id="slogan" rows="4" placeholder="Sloganınızı yazın..."></textarea><br>

    <button class="button" onclick="startBroadcast()" id="broadcastBtn">Bas Sat</button>
    <a href="canli-yayin-satin-al.html" class="button">Süre Ekle</a>
    <a href="toptancilar-panel.html" class="button">Geri</a>

    <div id="subtitles"></div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        const socket = io('http://localhost:3001', {
            transports: ['polling', 'websocket']
        }); // Connect to live stream server
        const currentUser = JSON.parse(localStorage.getItem('currentUser')) || { email: 'test@toptancilar.com', panel: 'toptancilar' };

        // Panel sahibinin ürünlerini yükle
        let userProducts = [];
        let selectedProducts = [];

        function loadUserProducts() {
            // localStorage'dan toptancının ürünlerini al
            const products = JSON.parse(localStorage.getItem('products-toptancilar')) || [];
            userProducts = products.filter(p => p.owner === currentUser.email);

            const productCheckboxes = document.getElementById('productCheckboxes');
            const noProductsMessage = document.getElementById('noProductsMessage');

            if (userProducts.length === 0) {
                noProductsMessage.style.display = 'block';
                productCheckboxes.innerHTML = '';
                return;
            }

            noProductsMessage.style.display = 'none';
            productCheckboxes.innerHTML = '';

            userProducts.forEach(product => {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.style.margin = '5px 0';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = 'product-' + product.name;
                checkbox.value = product.name;
                checkbox.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        selectedProducts.push(product);
                    } else {
                        selectedProducts = selectedProducts.filter(p => p.name !== product.name);
                    }
                });

                const label = document.createElement('label');
                label.htmlFor = 'product-' + product.name;
                label.textContent = `${product.name} - ${product.price} TL (Stok: ${product.stock})`;
                label.style.marginLeft = '5px';

                checkboxDiv.appendChild(checkbox);
                checkboxDiv.appendChild(label);
                productCheckboxes.appendChild(checkboxDiv);
            });
        }

        // Sayfa yüklendiğinde ürünleri yükle
        window.addEventListener('load', loadUserProducts);

        let localStream;
        let producerTransport;
        let device;
        let isBroadcasting = false;

        let statusDiv = document.createElement('div');
        statusDiv.id = 'status';
        statusDiv.style.cssText = 'margin: 20px 0; padding: 10px; border-radius: 5px; background-color: #333; color: #fff;';
        statusDiv.textContent = 'Bağlantı bekleniyor...';
        document.body.insertBefore(statusDiv, document.querySelector('h1').nextSibling);

        // Initially disable broadcast button until connected
        const broadcastBtn = document.getElementById('broadcastBtn');
        broadcastBtn.disabled = true;
        broadcastBtn.textContent = 'Bağlantı bekleniyor...';

        socket.on('connect', () => {
            statusDiv.textContent = 'Sunucuya bağlandı - Yayın hazır!';
            statusDiv.style.backgroundColor = '#4CAF50';
            broadcastBtn.disabled = false;
            broadcastBtn.textContent = 'Bas Sat';
        });

        socket.on('disconnect', () => {
            statusDiv.textContent = 'Sunucu bağlantısı kesildi';
            statusDiv.style.backgroundColor = '#f44336';
        });

        socket.on('connect_error', (error) => {
            statusDiv.textContent = 'Bağlantı hatası: ' + error.message;
            statusDiv.style.backgroundColor = '#f44336';
        });

        // Mock AI Translation Dictionary
        const translations = {
            'en': {
                'Welcome to the live broadcast!': 'Canlı yayına hoş geldiniz!',
                'This product is amazing!': 'Bu ürün harika!',
                'Buy now!': 'Şimdi satın al!'
            },
            'tr': {
                'Welcome to the live broadcast!': 'Canlı yayına hoş geldiniz!',
                'This product is amazing!': 'Bu ürün harika!',
                'Buy now!': 'Şimdi satın al!'
            },
            'es': {
                'Welcome to the live broadcast!': '¡Bienvenido a la transmisión en vivo!',
                'This product is amazing!': '¡Este producto es increíble!',
                'Buy now!': '¡Compra ahora!'
            }
            // Add more languages as needed
        };

        function getTranslation(text, targetLang) {
            // Mock AI translation - in real implementation, use Google Translate API or similar
            const phrases = Object.keys(translations['en']);
            for (let phrase of phrases) {
                if (text.includes(phrase)) {
                    return translations[targetLang][phrase] || text;
                }
            }
            return text; // Fallback to original
        }

        async function startBroadcast() {
            console.log('startBroadcast called');
            const slogan = document.getElementById('slogan').value;
            console.log('Selected products:', selectedProducts, 'Slogan:', slogan);

            if (selectedProducts.length === 0) {
                alert('Lütfen en az bir ürün seçin.');
                return;
            }

            if (!slogan) {
                alert('Lütfen slogan yazın.');
                return;
            }

            // Yayın süresi kontrolü
            const remainingTime = parseInt(localStorage.getItem('broadcastTimeRemaining') || '0');
            if (remainingTime <= 0) {
                alert('Yayın süreniz yok. Lütfen önce süre satın alın.');
                window.location.href = 'canli-yayin-satin-al.html';
                return;
            }

            // Update status and button
            statusDiv.textContent = 'Kamera/mikrofon erişimi isteniyor...';
            statusDiv.style.backgroundColor = '#ff9800';
            broadcastBtn.disabled = true;
            broadcastBtn.textContent = 'Yayın hazırlanıyor...';
            console.log('Button disabled during broadcast setup');

            try {
                // Get camera and microphone access
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });

                statusDiv.textContent = 'Medya erişimi başarılı, yayın hazırlanıyor...';
                statusDiv.style.backgroundColor = '#2196F3';

                // Get router RTP capabilities
                socket.emit('getRouterRtpCapabilities', async (rtpCapabilities) => {
                    try {
                        // Load Mediasoup client device
                        device = new MediasoupClient.Device();
                        await device.load({ routerRtpCapabilities: rtpCapabilities });

                        // Create producer transport
                        socket.emit('createProducerTransport', async (transportParams) => {
                            console.log('Transport params received:', transportParams);
                            producerTransport = device.createSendTransport(transportParams);

                            producerTransport.on('connect', async ({ dtlsParameters }, callback) => {
                                socket.emit('connectProducerTransport', { dtlsParameters }, callback);
                            });

                            producerTransport.on('produce', async ({ kind, rtpParameters }, callback) => {
                                socket.emit('produce', { kind, rtpParameters }, callback);
                            });

                            // Produce video track
                            const videoTrack = localStream.getVideoTracks()[0];
                            await producerTransport.produce({ track: videoTrack });

                            // Produce audio track
                            const audioTrack = localStream.getAudioTracks()[0];
                            await producerTransport.produce({ track: audioTrack });

                            isBroadcasting = true;
                            statusDiv.textContent = 'Yayın başladı! İzleyiciler bağlanabilir.';
                            statusDiv.style.backgroundColor = '#4CAF50';
                            broadcastBtn.disabled = true;
                            broadcastBtn.textContent = 'Yayın aktif';

                            // Seçilen ürünler için komisyon hesapla ve logla
                            let totalCommission = 0;
                            const productNames = selectedProducts.map(p => p.name).join(', ');

                            selectedProducts.forEach(product => {
                                // Komisyon hesapla (varsayılan %10)
                                const commissionRate = 10; // Gerçek uygulamada ürün bazlı olabilir
                                const commissionAmount = product.price * (commissionRate / 100);
                                totalCommission += commissionAmount;

                                const commissionSale = {
                                    product: product.name,
                                    seller: currentUser.email,
                                    commissionAmount: commissionAmount,
                                    date: new Date().toISOString(),
                                    status: 'unpaid'
                                };
                                const commissionSales = JSON.parse(localStorage.getItem('commissionSales')) || [];
                                commissionSales.push(commissionSale);
                                localStorage.setItem('commissionSales', JSON.stringify(commissionSales));
                            });

                            // Yayın süresini başlat (geriye sayım)
                            startBroadcastCountdown();

                            // Log activity for hareket-takip.html
                            const activity = {
                                panel: currentUser.panel,
                                action: 'Canlı Yayın Başlatıldı - Ürünler: ' + productNames,
                                time: new Date().toISOString()
                            };
                            const activities = JSON.parse(localStorage.getItem('liveBroadcastActivities')) || [];
                            activities.push(activity);
                            localStorage.setItem('liveBroadcastActivities', JSON.stringify(activities));

                            alert('Canlı yayın başlatıldı!\nÜrünler: ' + productNames + '\nSlogan: ' + slogan + '\nToplam Komisyon: ' + totalCommission.toFixed(2) + ' TL');

                            // Start subtitles
                            startSubtitles(slogan);
                        });
                            } catch (error) {
                                statusDiv.textContent = 'Yayın hatası: ' + (error.message || error);
                                statusDiv.style.backgroundColor = '#f44336';
                                alert('Yayın başlatma hatası: ' + (error.message || error));
                            }
                });
            } catch (error) {
                statusDiv.textContent = 'Medya erişimi reddedildi';
                statusDiv.style.backgroundColor = '#f44336';
                broadcastBtn.disabled = false;
                broadcastBtn.textContent = 'Tekrar Dene';
                alert('Kamera/mikrofon erişimi reddedildi: ' + (error.message || error));
                return;
            }
        }

        let broadcastCountdownInterval;

        function startBroadcastCountdown() {
            // Yayın süresi sayacını başlat
            let remainingTime = parseInt(localStorage.getItem('broadcastTimeRemaining') || '0');

            if (remainingTime > 0) {
                broadcastCountdownInterval = setInterval(() => {
                    remainingTime--;
                    localStorage.setItem('broadcastTimeRemaining', remainingTime.toString());

                    if (remainingTime <= 0) {
                        clearInterval(broadcastCountdownInterval);
                        alert('Yayın süreniz doldu! Yayın durduruluyor.');
                        stopBroadcast();
                    }
                }, 1000);
            }
        }

        function startSubtitles(slogan) {
            const viewerLang = 'es'; // Mock viewer language
            const broadcasterLang = 'tr'; // Mock broadcaster language

            const subtitleTexts = [
                getTranslation('Welcome to the live broadcast!', viewerLang),
                getTranslation(slogan, viewerLang),
                getTranslation('This product is amazing!', viewerLang),
                getTranslation('Buy now!', viewerLang)
            ];

            let index = 0;
            const subtitleInterval = setInterval(() => {
                const subtitlesDiv = document.getElementById('subtitles');
                subtitlesDiv.textContent = subtitleTexts[index % subtitleTexts.length];
                subtitlesDiv.style.display = 'block';
                index++;
            }, 5000); // Change subtitle every 5 seconds

            // Stop subtitles after 2 minutes for demo (gerçek uygulamada süre bitimine göre)
            setTimeout(() => {
                clearInterval(subtitleInterval);
                document.getElementById('subtitles').style.display = 'none';
                // Yayın süresi kontrolü için stopBroadcast() burada çağrılmaz
            }, 120000);
        }

        function stopBroadcast() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            if (producerTransport) {
                producerTransport.close();
            }
            if (broadcastCountdownInterval) {
                clearInterval(broadcastCountdownInterval);
            }
            isBroadcasting = false;
            alert('Yayın durduruldu.');
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mediasoup-client@3.6.37/lib/index.min.js"></script>
    <script>
        // Ensure MediasoupClient is available globally
        if (typeof MediasoupClient === 'undefined') {
            console.error('MediasoupClient not loaded');
        }
    </script>
</body>
</html>
